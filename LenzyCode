WITH FilteredClaims AS (
    SELECT *
    FROM CLAIM C1
    WHERE ADJ_DATE_TIME >= DATEADD(DAY, 1, EOMONTH(GETDATE(), -2))
	  AND TRANSACTION_STATUS <> 'RJ'
      AND NOT EXISTS (
	SELECT 1
	FROM CLAIM C2
	WHERE C2.claim_id = C1.claim_id
	AND C2.TRANSACTION_STATUS = 'RL'
	)


)



Select distinct
	O.CARRIER_NUMBER as CUSTOMER_ID ,
O.CARRIER_NAME as  CUSTOMER_NAME,
O.ACCOUNT_NUMBER as CLIENT_ID ,
O.ACCOUNT_NAME as CLIENT_NAME ,
O.GROUP_NUMBER as CLIENT_GROUP_ID ,
O.GROUP_NAME as GROUP_NAME ,
C.ADJUDICATED_BIN as BIN_NUMBER ,
C.CARDHOLDER_ID as MEMBER_ID ,
MC.ALTERNATE_MEMBER_ID_1 as ALT_MEMBER_ID ,
C.PERSON_CODE as PERSON_CODE ,
C.RELATIONSHIP_CODE as RELATIONSHIP_CODE ,
MC.MEMBER_DOB as DATE_OF_BIRTH ,
MC.MEMBER_GENDER as SEX_OF_PATIENT ,
MC.MEMBER_FIRST_NAME as FIRST_NAME ,
MC.MEMBER_LAST_NAME as LAST_NAME ,
C.DATE_FILLED as DATE_FILLED ,
C.ADJ_DATE_TIME as DATE_SUBMITTED ,
C.CLAIM_ID as CLAIM_REFERENCE_NUMBER ,
C.TRANSACTION_STATUS as TRANSACTION_STATUS,
C.RX_NUMBER as RX_NUMBER ,
C.PRESCRIPTION_DATE_WRITTEN as DATE_RX_WRITTEN ,
C.CLAIM_ORIGIN_CODE as RX_ORIGIN ,
C.CLAIM_TYPE_ID as CLAIM_TYPE  ,
C.PRESCRIBER_NPI as PRESCRIBER_ID ,
--PS.PRESCRIBER_FIRST_NAME as PRESCRIBER_FIRST_NAME ,
--PS.PRESCRIBER_LAST_NAME as PRESCRIBER_LAST_NAME ,
P.PHARMACY_NCPDP_ID as PHARMACY_NABP ,
P.PHARMACY_NPI as PHARMACY_NPI ,
P.PHARMACY_NAME as PHARMACY_NAME ,
PR.PHARMACY_RELATIONSHIP_NAME as PHARMACY_CHAIN_NAME ,
C.NDC as NDC ,
C.DRUG_NAME as DRUG_NAME ,
D.MANUFACTURER_NAME as MANUFACTURER_NAME ,
C.GPI as GPI ,
C.DRUG_STRENGTH as STRENGTH ,
D.FORM as FORM ,
C.MONY as GENERIC_CODE ,
C.MAINTENANCE_FLAG as MAINT_DRUG ,
C.COMPOUND_INDICATOR as COMPOUND_CODE ,
C.RX_OTC_INDICATOR as RX_OTC_INDICATOR ,
C.QUANTITY_DISPENSED as QUANTITY ,
C.DAYS_SUPPLY as DAYS_SUPPLY ,
C.CLIENT_BASIS_OF_COST_DETERMINATION as BASIS_OF_COST ,
C.AWP_TOTAL as AWP_TOTAL ,
C.MAC_TOTAL as MAC_TOTAL ,
C.SUBMITTED_DISPENSING_FEE as SUBMITTED_FEE ,
C.SUBMITTED_INGREDIENT_COST as SUBMITTED_INGREDIENT_COST ,
C.SUBMITTED_U_C as USUAL_AND_CUSTOMARY_CHARGE ,
C.CLIENT_INGREDIENT_COST as INGREDIENT_COST ,
C.CLIENT_DISPENSING_FEE as DISPENSING_FEE ,
C.CLIENT_SALES_TAX as SALES_TAX ,
C.TOTAL_MEMBER_PAID as COPAY ,
C.OTHER_PAYER_AMOUNT_RECOGNIZED as OTHER_PAYER_AMOUNT_RECOGNIZED ,
C.CLIENT_PLAN_PAID as TOTAL_AMOUNT_DUE ,
--MP.PA_NUMBER as PRIOR_AUTH_CODE ,
D.AHFS_DESC_4 as THERAPEUTIC_CLASS_DESC ,
C.OTHER_COVERAGE_CODE as OTHER_COVERAGE_CODE,

CLAIM_ID
OTHER_PAYER_PAID_AMOUNT_QUAL_COUNT
OTHER_PAYER_PAID_AMOUNT_QUALIFIER
OTHER_PAYER_PAID_AMOUNT
PATIENT_PAID_QUALIFIER_COUNT
PATIENT_PAID_QUALIFIER
PATIENT_PAID_QUALIFIER_AMOUNT


 

FROM FilteredClaims AS C
INNER JOIN DRUG AS D
    ON C.NDC = D.NDC
   AND C.DATE_FILLED >= D.DWH_EFFECTIVE_START_DT
   AND C.DATE_FILLED < D.DWH_EFFECTIVE_END_DT
LEFT JOIN OCAG AS O
    ON C.group_id = O.groupid
LEFT JOIN MEMBER_CARD AS MC
    ON C.member_card_id = MC.member_card_id
   AND C.group_id = MC.group_id
LEFT JOIN PHARMACY AS P
    ON C.PHARMACY_NCPDP_ID = P.PHARMACY_NCPDP_ID
--LEFT JOIN PRESCRIBER AS PS
    --ON C.PRESCRIBER_NPI = PS.PRESCRIBER_NPI
--LEFT JOIN MEMBER_PRIORAUTHORIZATION AS MP
  --  ON C.PERSON_CODE = CAST(MP.PERSON_CODE AS VARCHAR)
LEFT JOIN PHARMACY_RELATIONSHIP PR
    ON P.PHARMACY_NCPDP_ID = PR.PHARMACY_NCPDP_ID

